<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Climate Weather AI/ML Model - Lucie – Training Resources</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b7552c6a5f77d2b4ee8e8355a1491179.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/NCI logo White small.png" alt="" class="navbar-logo light-content">
    <img src="../img/NCI logo White small.png" alt="" class="navbar-logo dark-content">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Training Resources</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
    <a href="https://github.com/orgs/NCI900-Training-Organisation/repositories" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Example-Notebooks/aardvark.html">Example Notebooks</a></li><li class="breadcrumb-item"><a href="../Example-Notebooks/lucie.html">Climate Weather AI/ML Model - Lucie</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../courses.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Self-paced Courses</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Example Notebooks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Example-Notebooks/aardvark.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Climate Weather AI/ML Model - Aardvark Weather</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Example-Notebooks/lucie.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Climate Weather AI/ML Model - Lucie</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Getting Started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Getting-Started/accounts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Accounts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Getting-Started/filetransfer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">File Transfer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Getting-Started/logingadi.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Login to Gadi</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Getting-Started/use-jupyterlab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Run Jupyter Notebooks on Gadi</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#cluster-access" id="toc-cluster-access" class="nav-link active" data-scroll-target="#cluster-access">Cluster Access</a></li>
  <li><a href="#run-the-tested-notebook" id="toc-run-the-tested-notebook" class="nav-link" data-scroll-target="#run-the-tested-notebook">Run the tested notebook</a></li>
  <li><a href="#note-on-the-tested-notebook" id="toc-note-on-the-tested-notebook" class="nav-link" data-scroll-target="#note-on-the-tested-notebook">Note on the tested notebook</a></li>
  <li><a href="#lucie" id="toc-lucie" class="nav-link" data-scroll-target="#lucie">LUCIE</a></li>
  <li><a href="#data-inspection" id="toc-data-inspection" class="nav-link" data-scroll-target="#data-inspection">Data Inspection</a>
  <ul class="collapse">
  <li><a href="#normalization-scalars" id="toc-normalization-scalars" class="nav-link" data-scroll-target="#normalization-scalars">Normalization Scalars</a></li>
  <li><a href="#variable-fields" id="toc-variable-fields" class="nav-link" data-scroll-target="#variable-fields">Variable Fields</a></li>
  </ul></li>
  <li><a href="#replicate-training" id="toc-replicate-training" class="nav-link" data-scroll-target="#replicate-training">Replicate Training</a>
  <ul class="collapse">
  <li><a href="#suggested-exercises" id="toc-suggested-exercises" class="nav-link" data-scroll-target="#suggested-exercises">Suggested Exercises</a></li>
  </ul></li>
  <li><a href="#modified-training" id="toc-modified-training" class="nav-link" data-scroll-target="#modified-training">Modified Training</a>
  <ul class="collapse">
  <li><a href="#suggested-exercises-1" id="toc-suggested-exercises-1" class="nav-link" data-scroll-target="#suggested-exercises-1">Suggested Exercises</a></li>
  </ul></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference">Inference</a>
  <ul class="collapse">
  <li><a href="#visualize-rollout-results" id="toc-visualize-rollout-results" class="nav-link" data-scroll-target="#visualize-rollout-results">Visualize Rollout Results</a></li>
  <li><a href="#check-the-spatial-pattern" id="toc-check-the-spatial-pattern" class="nav-link" data-scroll-target="#check-the-spatial-pattern">Check the Spatial Pattern</a></li>
  <li><a href="#check-climatology-bias" id="toc-check-climatology-bias" class="nav-link" data-scroll-target="#check-climatology-bias">Check Climatology Bias</a></li>
  <li><a href="#compare-global-mean-over-time" id="toc-compare-global-mean-over-time" class="nav-link" data-scroll-target="#compare-global-mean-over-time">Compare Global Mean over Time</a></li>
  <li><a href="#suggested-exercises-2" id="toc-suggested-exercises-2" class="nav-link" data-scroll-target="#suggested-exercises-2">Suggested Exercises</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.dev/NCI900-Training-Organisation/learning-resources.git/blob/main/Example-Notebooks/lucie.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/NCI900-Training-Organisation/learning-resources.git/blob/main/Example-Notebooks/lucie.ipynb" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/NCI900-Training-Organisation/learning-resources.git/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../Example-Notebooks/aardvark.html">Example Notebooks</a></li><li class="breadcrumb-item"><a href="../Example-Notebooks/lucie.html">Climate Weather AI/ML Model - Lucie</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Climate Weather AI/ML Model - Lucie</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="cluster-access" class="level2">
<h2 class="anchored" data-anchor-id="cluster-access">Cluster Access</h2>
<ol type="1">
<li><a href="https://my.nci.org.au/mancini">Create an NCI account&nbsp;</a>using <strong>institution email</strong></li>
<li>Join below NCI projects
<ul>
<li><a href="https://aus01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fmy.nci.org.au%2Fmancini%2Fproject%2Fvp91&amp;data=05%7C02%7CZhuochen.Wu%40anu.edu.au%7Cf5a89cc20ce54084a5a408dda23d8170%7Ce37d725cab5c46249ae5f0533e486437%7C0%7C0%7C638845107242745767%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&amp;sdata=U5QIrogOxO%2FbxR8Y7FGaB8tA1hzCGOzqP4QiFiqv5XU%3D&amp;reserved=0">vp91:NCI Training Project</a></li>
<li><a href="https://my.nci.org.au/mancini/project/dk92/join">dk92: for environment modules and some examples</a></li>
<li><a href="https://my.nci.org.au/mancini/project/wb00/join">wb00: for NCI-WeatherBench and ClimateNet datasets</a></li>
<li><a href="https://my.nci.org.au/mancini/project/rt52/join">rt52: for ERA5 datasets</a></li>
<li><a href="https://my.nci.org.au/mancini/project/ob53/join">ob53: for BARRA2 datasets</a></li>
</ul></li>
</ol>
</section>
<section id="run-the-tested-notebook" class="level2">
<h2 class="anchored" data-anchor-id="run-the-tested-notebook">Run the tested notebook</h2>
<ol type="1">
<li>Go to <a href="are.nci.org.au">ARE site</a><br>
</li>
<li>Fill out the JupyterLab request form:<br>
</li>
</ol>
<ul>
<li><strong>Walltime (hours)</strong>: <code>1</code></li>
<li><strong>Queue</strong>: <code>gpuvolta</code></li>
<li><strong>Compute Size</strong>: <code>1gpu</code></li>
<li><strong>Project</strong>: <code>&lt;xy01&gt;</code></li>
<li><strong>Storage</strong>: <code>gdata/dk92+scratch/&lt;xy01&gt;</code></li>
</ul>
<ol start="3" type="1">
<li>Click <strong><em>Advanced options</em></strong> and fill in the following fields:<br>
</li>
</ol>
<ul>
<li><strong>Module directories</strong>: <code>/g/data/dk92/apps/Modules/modulefiles/</code><br>
</li>
<li><strong>Modules</strong>: <code>NCI-ai-ml/25.07</code><br>
</li>
<li><strong>Jobfs size</strong>: <code>10GB</code><br>
</li>
</ul>
<ol start="4" type="1">
<li>Launch the session to run the tested notebook</li>
</ol>
</section>
<section id="note-on-the-tested-notebook" class="level2">
<h2 class="anchored" data-anchor-id="note-on-the-tested-notebook">Note on the tested notebook</h2>
<p>Copy the tested notebook from any/all of the following path to your own working directory. If your working directory is different from “/scratch/<xy01>”, remember to change the storage directive in the JupyterLab request form.</xy01></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/g/data/dk92/notebooks/examples-aiml/lucie/data_inspection.ipynb</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">/g/data/dk92/notebooks/examples-aiml/lucie/replicate_training.ipynb</span> </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">/g/data/dk92/notebooks/examples-aiml/lucie/modified_training.ipynb</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">/g/data/dk92/notebooks/examples-aiml/lucie/inference_10y_rollout.ipynb</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>All the notebooks are using the original dataset released with the LUCIE paper inside their zenodo record [3]. checkpoints for models trained on Gadi is available in the directory <code>/g/data/dk92/notebooks/examples-aiml/lucie/checkpoints</code> together with the original checkpoint, <code>regular_8x72_fftreg_baseline.pth</code>, released with the LUCIE paper.</p>
</section>
<section id="lucie" class="level2">
<h2 class="anchored" data-anchor-id="lucie">LUCIE</h2>
<p>LUCIE is a SFNO based atmospheric emulator that can be used for climate research. It is notable for its long-term stability in autoregressive predictions, maintaining an unbiased climatology for thousands of years. It was trained on 9.5 years of regridded ERA5 data on T30 grid, incorporating static input of orography, forcing variable of total incident solar radiation, five prognostic variables (temperature, humidity, zonal wind, meridional wind, and surface pressure), and one diagnostic variable of precipitation.</p>
<p>In the paper [1], Guan et al.&nbsp;demonstrate LUCIE’s ability to reproduce long-term climatology as well as its skill in subseasonal-to-seasonal scale predictions of atmospheric variables. Using 100 years of autoregressive inference with 100 ensemble members, they showcase the model’s stability and the variability of mean climatology. The ensemble outputs were further analysed to identify northern hemisphere annular mode(NAM), southern hemisphere annular mode (SAM) and the return period of extreme events.</p>
<p>At NCI, we made the environment NCI-ai-ml compatible to run LUCIE, and prepared four notebooks introducing its dataset, training and inference workflow. In addition, we extended the model to exploit the resolution-invariant property of neural operators by removing LUCIE’s positional embedding, see details in the notebook <code>modified_training.ipynb</code>. All the four notebooks are primarily based on their released code [2][3], which we adapted for training and inference on Gadi.</p>
<p>Beyond the notebooks, we further tested multiple model architectural configurations, training datasets with different spatial resolutions and variable sets, and explored alternative training strategies. For example, results presented in the <code>Stable Rollout</code> section showcase a 1° model with 25 output variables, capable of generating stable rollouts at six-hour interval for up to ten years. Please note the current limitation arises from the length of our dataset, not the capability of the model.</p>
<p>References:<br>
1. Guan, H., Arcomano, T., Chattopadhyay, A., &amp; Maulik, R. (2024). LUCIE: A Lightweight Uncoupled ClImate Emulator with long-term stability and physical consistency for O(1000)-member ensembles. arXiv preprint arXiv:2405.16297. https://arxiv.org/abs/2405.16297</p>
<ol start="2" type="1">
<li><p>ISCLPennState. (2024). LUCIE: Lightweight Uncoupled ClImate Emulator [Software]. GitHub. https://github.com/ISCLPennState/LUCIE</p></li>
<li><p>Guan, H., Arcomano, T., Chattopadhyay, A., &amp; Maulik, R. (2025). LUCIE: A lightweight uncoupled climate emulator with long-term stability and physical consistency. Zenodo. https://doi.org/10.5281/zenodo.15164648</p></li>
</ol>
</section>
<section id="data-inspection" class="level1">
<h1>Data Inspection</h1>
<div id="992146ca-128e-4641-9c30-168b61383128" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:11:18.645897Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:11:18.645305Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:11:19.364772Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:11:19.362963Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:11:18.645839Z&quot;}}" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>module <span class="bu">list</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Currently Loaded Modulefiles:
 1) openmpi/4.1.5   2) singularity   3) NCI-ai-ml/25.07   4) pbs  </code></pre>
</div>
</div>
<div id="b5ab7aec-7750-4257-b0d3-88ffb464b4e1" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:11:26.395809Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:11:26.395158Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:11:35.233238Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:11:35.231738Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:11:26.395749Z&quot;}}" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.stats <span class="im">as</span> stats</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ced36b93-1945-43ec-b9e7-ab6446e4363b" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:12:00.586065Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:12:00.585086Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:12:02.110687Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:12:02.109468Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:12:00.586004Z&quot;}}" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>nb_dir <span class="op">=</span> <span class="st">"/g/data/dk92/notebooks/examples-aiml/lucie"</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.load(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/datasets/era5_T30_regridded.npz"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>data.files</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>['temperature',
 'humidity',
 'u_wind',
 'v_wind',
 'surface_pressure',
 'precipitation',
 'tisr',
 'orography']</code></pre>
</div>
</div>
<section id="normalization-scalars" class="level2">
<h2 class="anchored" data-anchor-id="normalization-scalars">Normalization Scalars</h2>
<div id="d6cb463e-9157-4983-8915-b6fd379c28ff" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:12:05.141490Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:12:05.140857Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:12:11.895129Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:12:11.894140Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:12:05.141431Z&quot;}}" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># comparing mean, std to era5, t-&gt; t1000, q -&gt; q1000, z-&gt;z200, u-&gt; u200, v-&gt; v200</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> var <span class="kw">in</span> data.files:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    mm <span class="op">=</span> data[var].mean()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    ss <span class="op">=</span> data[var].std()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">: mean=</span><span class="sc">{</span>mm<span class="sc">}</span><span class="ss">, std=</span><span class="sc">{</span>ss<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>temperature: mean=277.4626770019531, std=17.816375732421875
humidity: mean=0.006629979237914085, std=0.005532822106033564
u_wind: mean=10.695755004882812, std=15.56001091003418
v_wind: mean=-0.02342492900788784, std=12.149330139160156
surface_pressure: mean=96811.390625, std=9123.89453125
precipitation: mean=0.0006106931250542402, std=0.001604488817974925
tisr: mean=1079093.125, std=1444145.25
orography: mean=367.17120361328125, std=809.2915649414062</code></pre>
</div>
</div>
<div id="1d2786b6-d032-4696-939f-bbf9671a0cc6" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:12:44.988111Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:12:44.987456Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:12:52.511268Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:12:52.510420Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:12:44.988051Z&quot;}}" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.load(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/datasets/era5_T30_preprocessed.npz"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>data_inp <span class="op">=</span> data[<span class="st">"data_inp"</span>]     <span class="co"># input data </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>data_tar <span class="op">=</span> data[<span class="st">"data_tar"</span>]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>raw_means <span class="op">=</span> data[<span class="st">"raw_means"</span>]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>raw_stds <span class="op">=</span> data[<span class="st">"raw_stds"</span>]</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>prog_means <span class="op">=</span> raw_means[:<span class="dv">5</span>] <span class="co"># this is literally zero?</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>prog_stds <span class="op">=</span> raw_stds[:<span class="dv">5</span>] <span class="co"># this is literally zero?</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>diag_means <span class="op">=</span> data[<span class="st">"diag_means"</span>]</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>diag_stds <span class="op">=</span> data[<span class="st">"diag_stds"</span>]</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>diff_means <span class="op">=</span> data[<span class="st">"diff_means"</span>]</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>diff_stds <span class="op">=</span> data[<span class="st">"diff_stds"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="7edf2ac3-5729-4583-af4b-230b65bc7228" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:12:52.512622Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:12:52.512425Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:12:52.518584Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:12:52.517833Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:12:52.512605Z&quot;}}" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">vars</span> <span class="op">=</span> [<span class="st">'temperature'</span>, <span class="st">'humidity'</span>, <span class="st">'u_wind'</span>, <span class="st">'v_wind'</span>, <span class="st">'surface_pressure'</span>, <span class="st">'tisr'</span>, <span class="st">'orography'</span>]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(<span class="bu">zip</span>(<span class="bu">vars</span>, raw_means, raw_stds))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>[('temperature', np.float64(277.462646484375), np.float64(17.816408157348633)),
 ('humidity',
  np.float64(0.006629981566220522),
  np.float64(0.005532818380743265)),
 ('u_wind', np.float64(10.695756912231445), np.float64(15.56002426147461)),
 ('v_wind', np.float64(-0.023422522470355034), np.float64(12.14930534362793)),
 ('surface_pressure', np.float64(96811.390625), np.float64(9123.8916015625)),
 ('tisr', np.float64(1079094.75), np.float64(1444147.125)),
 ('orography', np.float64(367.17120361328125), np.float64(809.2916259765625))]</code></pre>
</div>
</div>
<div id="f1759fb1-43f7-4e6a-9d4b-f38c84540dc1" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:12:52.519150Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:12:52.518985Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:12:52.536564Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:12:52.535690Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:12:52.519133Z&quot;}}" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">vars</span><span class="op">=</span> [<span class="st">'temperature'</span>, <span class="st">'humidity'</span>, <span class="st">'u_wind'</span>, <span class="st">'v_wind'</span>, <span class="st">'surface_pressure'</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(<span class="bu">zip</span>(<span class="bu">vars</span>, diff_means, diff_stds))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>[('temperature',
  np.float64(9.803541615838185e-05),
  np.float64(1.4138480424880981)),
 ('humidity',
  np.float64(2.0586108817610693e-08),
  np.float64(0.0005922476993873715)),
 ('u_wind',
  np.float64(-3.1180163205135614e-05),
  np.float64(4.642238140106201)),
 ('v_wind', np.float64(-5.063314802100649e-06), np.float64(5.960874080657959)),
 ('surface_pressure',
  np.float64(0.0021911216899752617),
  np.float64(241.07797241210938))]</code></pre>
</div>
</div>
<div id="2ef0eca2-8f97-4a4d-a7b2-f3c7e2df0fb4" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:13:09.925080Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:13:09.924446Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:13:09.935876Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:13:09.934366Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:13:09.925022Z&quot;}}" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(<span class="bu">zip</span>(<span class="bu">vars</span>,[ diff_stds[ii] <span class="op">/</span> raw_stds[ii] <span class="cf">for</span> ii <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>) ]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>[('temperature', np.float64(0.07935651395059314)),
 ('humidity', np.float64(0.1070426785467356)),
 ('u_wind', np.float64(0.298343888293286)),
 ('v_wind', np.float64(0.4906349714705557)),
 ('surface_pressure', np.float64(0.026422713348635562))]</code></pre>
</div>
</div>
<div id="9e24649a-633c-4e1c-8d8b-3927fd012ca3" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:13:11.183804Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:13:11.183180Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:13:11.193377Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:13:11.191860Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:13:11.183746Z&quot;}}" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for log scale preciptation</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>diag_means,diag_stds</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>(array([0.05197881]), array([0.11017133]))</code></pre>
</div>
</div>
</section>
<section id="variable-fields" class="level2">
<h2 class="anchored" data-anchor-id="variable-fields">Variable Fields</h2>
<div id="387e64fd-cadb-4e01-8e08-fcb3e5fc6c1b" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:14:02.562962Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:14:02.562306Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:14:10.138787Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:14:10.137994Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:14:02.562903Z&quot;}}" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>wdir <span class="op">=</span> <span class="st">"/g/data/z00/yxs900/neuraloperators/sfno/curriculum_learning/lowRes/experiments/03_LUCIE/LUCIE_fix"</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>raw_data <span class="op">=</span> np.load(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/datasets/era5_T30_regridded.npz"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.load(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/datasets/era5_T30_preprocessed.npz"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>data_inp <span class="op">=</span> data[<span class="st">"data_inp"</span>]     <span class="co"># input data </span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>data_tar <span class="op">=</span> data[<span class="st">"data_tar"</span>]</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>inp_vars <span class="op">=</span> [<span class="st">'temperature'</span>, <span class="st">'humidity'</span>, <span class="st">'u_wind'</span>, <span class="st">'v_wind'</span>, <span class="st">'surface_pressure'</span>, <span class="st">'tisr'</span>, <span class="st">'orography'</span>]</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>tar_vars <span class="op">=</span> [<span class="st">'temperature'</span>, <span class="st">'humidity'</span>, <span class="st">'u_wind'</span>, <span class="st">'v_wind'</span>, <span class="st">'surface_pressure'</span>,<span class="st">'precipitation'</span>]</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>vars_to_plot <span class="op">=</span> [<span class="st">'temperature'</span>, <span class="st">'humidity'</span>, <span class="st">'u_wind'</span>, <span class="st">'v_wind'</span>, <span class="st">'surface_pressure'</span>, <span class="st">'tisr'</span>, <span class="st">'orography'</span>,<span class="st">'precipitation'</span>]</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>raw_data[<span class="st">"temperature"</span>].shape, data_inp.shape, data_tar.shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>((16538, 48, 96), (16537, 7, 48, 96), (16537, 6, 48, 96))</code></pre>
</div>
</div>
<div id="475b0dd3-3153-4991-b402-9753d473e247" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:14:13.723955Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:14:13.723320Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:14:13.737903Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:14:13.736516Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:14:13.723898Z&quot;}}" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> img2spectrum(img,ftr):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    npix <span class="op">=</span> img.shape[<span class="op">-</span><span class="dv">2</span>], img.shape[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    fft_img <span class="op">=</span> np.fft.fftn(img)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    fft_amp <span class="op">=</span> np.<span class="bu">abs</span>(fft_img)<span class="op">**</span><span class="dv">2</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    fft_amp <span class="op">=</span> fft_amp.flatten()</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    kfreq_x <span class="op">=</span> np.fft.fftfreq(npix[<span class="dv">1</span>]) <span class="op">*</span> npix[<span class="dv">1</span>] <span class="co"># wave vector</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    kfreq_y <span class="op">=</span> np.fft.fftfreq(npix[<span class="dv">0</span>]) <span class="op">*</span> npix[<span class="dv">0</span>] <span class="co"># wave vector</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    kfreq2D <span class="op">=</span> np.meshgrid(kfreq_x, kfreq_y)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    knrm <span class="op">=</span> np.sqrt(kfreq2D[<span class="dv">0</span>]<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> kfreq2D[<span class="dv">1</span>]<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    knrm <span class="op">=</span> knrm.flatten()</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">#kbins = np.arange(0.5, min(*npix)//2+1, 1.)</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    kbins <span class="op">=</span> np.arange(<span class="fl">0.5</span>, ftr, <span class="fl">1.</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    kvals <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> (kbins[<span class="dv">1</span>:] <span class="op">+</span> kbins[:<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    Abins, _, _ <span class="op">=</span> stats.binned_statistic(</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        knrm,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        fft_amp,</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>        statistic<span class="op">=</span><span class="st">'mean'</span>,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span>kbins</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    Abins <span class="op">*=</span> np.pi <span class="op">*</span> (kbins[<span class="dv">1</span>:]<span class="op">**</span><span class="dv">2</span> <span class="op">-</span> kbins[:<span class="op">-</span><span class="dv">1</span>]<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> kvals, Abins</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e6ef1b37-9884-4cc9-bbc7-30dff2a9ea37" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:14:19.155973Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:14:19.155358Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:14:21.881022Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:14:21.879991Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:14:19.155916Z&quot;}}" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the spatial and spectral pattern of all variable fields</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="bu">len</span>(vars_to_plot), <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">3</span> <span class="op">*</span> <span class="bu">len</span>(vars_to_plot)))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(vars_to_plot) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> [axes] </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ii, var <span class="kw">in</span> <span class="bu">enumerate</span>(vars_to_plot):</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(var)</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First column: original </span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var <span class="kw">in</span> inp_vars:</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> inp_vars.index(var)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        data_norm0 <span class="op">=</span> data_inp[:,idx,:,:].mean(axis<span class="op">=</span>(<span class="dv">0</span>,))</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">0</span>].pcolormesh(data_norm0)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">0</span>].set_title(<span class="ss">f"normalized input </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        ftr <span class="op">=</span> <span class="bu">max</span>(<span class="op">*</span>data_norm0.shape)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        kvals0, Abins0 <span class="op">=</span> img2spectrum(data_norm0,ftr)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">2</span>].plot(kvals0, Abins0<span class="op">/</span><span class="bu">max</span>(Abins0), label<span class="op">=</span><span class="st">"normalized input"</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Second column: normalized input data</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var <span class="kw">in</span> tar_vars:</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> tar_vars.index(var)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>        data_norm1 <span class="op">=</span> data_tar[:,idx,:,:].mean(axis<span class="op">=</span>(<span class="dv">0</span>,))</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">1</span>].pcolormesh(data_norm1)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">1</span>].set_title(<span class="ss">f"normalized tar </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        ftr <span class="op">=</span> <span class="bu">max</span>(<span class="op">*</span>data_norm1.shape)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        kvals1, Abins1 <span class="op">=</span> img2spectrum(data_norm1,ftr)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">2</span>].plot(kvals1, Abins1<span class="op">/</span><span class="bu">max</span>(Abins1), label<span class="op">=</span><span class="st">"normalized tar"</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># third column: normalized output data</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    axes[ii, <span class="dv">2</span>].legend()</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    axes[ii, <span class="dv">2</span>].set_title(<span class="ss">f"normalized spectrum: </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(hspace<span class="op">=</span><span class="fl">0.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="lucie_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="93db90af-59a4-41c8-8631-bcf184b7e6a5" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:14:39.672423Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:14:39.671781Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:14:45.136052Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:14:45.135218Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:14:39.672364Z&quot;}}" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the global mean over time of each variable</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="bu">len</span>(vars_to_plot), <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">3</span> <span class="op">*</span> <span class="bu">len</span>(vars_to_plot)))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(vars_to_plot) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> [axes] </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ii, var <span class="kw">in</span> <span class="bu">enumerate</span>(vars_to_plot):</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(var)</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First column: normalized input data</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> raw_data[var]</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    axes[ii, <span class="dv">0</span>].plot(data.mean(axis<span class="op">=</span>(<span class="op">-</span><span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>)))</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    axes[ii, <span class="dv">0</span>].set_title(<span class="ss">f"original </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Second column: normalized output data</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var <span class="kw">in</span> inp_vars:</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> inp_vars.index(var)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        data_norm0 <span class="op">=</span> data_inp[:,idx,:,:].mean(axis<span class="op">=</span>(<span class="op">-</span><span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">1</span>].plot(data_norm0)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">1</span>].set_title(<span class="ss">f"normalized input </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># third column: normalized input vs output data spectrum</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var <span class="kw">in</span> tar_vars:</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> tar_vars.index(var)</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        data_norm1 <span class="op">=</span> data_tar[:,idx,:,:].mean(axis<span class="op">=</span>(<span class="op">-</span><span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">2</span>].plot(data_norm1)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">2</span>].set_title(<span class="ss">f"normalized tar </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(hspace<span class="op">=</span><span class="fl">0.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="lucie_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ef799705-fb5b-4fdb-a377-d37ff193337b" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;execution&quot;,&quot;value&quot;:{&quot;iopub.execute_input&quot;:&quot;2025-09-03T07:14:45.137138Z&quot;,&quot;iopub.status.busy&quot;:&quot;2025-09-03T07:14:45.136955Z&quot;,&quot;iopub.status.idle&quot;:&quot;2025-09-03T07:15:19.320327Z&quot;,&quot;shell.execute_reply&quot;:&quot;2025-09-03T07:15:19.319509Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2025-09-03T07:14:45.137121Z&quot;}}" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the distribution of all variable fileds</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>wdir <span class="op">=</span> <span class="st">"/g/data/z00/yxs900/neuraloperators/sfno/curriculum_learning/lowRes/experiments/03_LUCIE/LUCIE_fix"</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>raw_data <span class="op">=</span> np.load(<span class="ss">f"</span><span class="sc">{</span>wdir<span class="sc">}</span><span class="ss">/era5_T30_regridded.npz"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.load(<span class="ss">f"</span><span class="sc">{</span>wdir<span class="sc">}</span><span class="ss">/era5_T30_preprocessed.npz"</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>data_inp <span class="op">=</span> data[<span class="st">"data_inp"</span>]     <span class="co"># input data </span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>data_tar <span class="op">=</span> data[<span class="st">"data_tar"</span>]</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>inp_vars <span class="op">=</span> [<span class="st">'temperature'</span>, <span class="st">'humidity'</span>, <span class="st">'u_wind'</span>, <span class="st">'v_wind'</span>, <span class="st">'surface_pressure'</span>, <span class="st">'tisr'</span>, <span class="st">'orography'</span>]</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>tar_vars <span class="op">=</span> [<span class="st">'temperature'</span>, <span class="st">'humidity'</span>, <span class="st">'u_wind'</span>, <span class="st">'v_wind'</span>, <span class="st">'surface_pressure'</span>,<span class="st">'precipitation'</span>]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>vars_to_plot <span class="op">=</span> [<span class="st">'temperature'</span>, <span class="st">'humidity'</span>, <span class="st">'u_wind'</span>, <span class="st">'v_wind'</span>, <span class="st">'surface_pressure'</span>, <span class="st">'tisr'</span>, <span class="st">'orography'</span>,<span class="st">'precipitation'</span>]</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="bu">len</span>(vars_to_plot), <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">3</span> <span class="op">*</span> <span class="bu">len</span>(vars_to_plot)))</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(vars_to_plot) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> [axes] </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ii, var <span class="kw">in</span> <span class="bu">enumerate</span>(vars_to_plot):</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(var)</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> raw_data[var]</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> data[<span class="op">~</span>np.isnan(data)]</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute min, max, 5th and 95th percentiles</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    vmin <span class="op">=</span> data.<span class="bu">min</span>()</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    vmax <span class="op">=</span> data.<span class="bu">max</span>()</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First column: original </span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    axes[ii, <span class="dv">0</span>].hist(data, bins<span class="op">=</span><span class="dv">100</span>,density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    axes[ii, <span class="dv">0</span>].set_title(<span class="ss">f"original </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">: min=</span><span class="sc">{</span>vmin<span class="sc">:.2f}</span><span class="ss">, max=</span><span class="sc">{</span>vmax<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Second column: normalized input data</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var <span class="kw">in</span> inp_vars:</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> inp_vars.index(var)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>        data_norm0 <span class="op">=</span> data_inp[:,idx,:,:].flatten()</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">1</span>].hist(data_norm0, bins<span class="op">=</span><span class="dv">100</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">1</span>].set_title(<span class="ss">f"normalized input </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># third column: normalized output data</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var <span class="kw">in</span> tar_vars:</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> tar_vars.index(var)</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>        data_norm1 <span class="op">=</span> data_tar[:,idx,:,:].flatten()</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">2</span>].hist(data_norm1, bins<span class="op">=</span><span class="dv">100</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>        axes[ii, <span class="dv">2</span>].set_title(<span class="ss">f"normalized tar </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>plt.subplots_adjust(hspace<span class="op">=</span><span class="fl">0.5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="lucie_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="replicate-training" class="level1">
<h1>Replicate Training</h1>
<div id="bde86a16" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>module <span class="bu">list</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Currently Loaded Modulefiles:
 1) openmpi/4.1.5   2) singularity   3) NCI-ai-ml/25.07   4) pbs  </code></pre>
</div>
</div>
<div id="77e9ab62" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> TensorDataset, DataLoader</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.optim.lr_scheduler <span class="im">import</span> CosineAnnealingLR</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys,os,time</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>nb_dir<span class="op">=</span><span class="st">"/g/data/dk92/notebooks/examples-aiml/lucie"</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/models"</span>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch_harmonics_local <span class="im">import</span> <span class="op">*</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> LUCIE_inference <span class="im">import</span> inference</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda:0'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    torch.cuda.set_device(<span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b595ca94" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define util functions, overide the one defined in LUCIE_train.py</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> integrate_grid(ugrid):</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    dlon <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> torch.pi <span class="op">/</span> nlon</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> torch.<span class="bu">sum</span>(ugrid <span class="op">*</span> quad_weights <span class="op">*</span> dlon, dim<span class="op">=</span>(<span class="op">-</span><span class="dv">2</span>, <span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> l2loss_sphere(prd, tar, relative<span class="op">=</span><span class="va">False</span>, squared<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> integrate_grid((prd <span class="op">-</span> tar)<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>(dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> relative:</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> loss <span class="op">/</span> integrate_grid(tar<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>(dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> squared:</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> torch.sqrt(loss)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> loss.mean()</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> loss</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(model, tdl, optimizer, scheduler<span class="op">=</span><span class="va">None</span>, nepochs<span class="op">=</span><span class="dv">20</span>, loss_fn<span class="op">=</span><span class="st">'l2'</span>):</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    infer_bias <span class="op">=</span> <span class="fl">1e+80</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    ibs <span class="op">=</span> torch.zeros(<span class="dv">1</span>,nepochs)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    best_bias <span class="op">=</span> <span class="fl">1e+80</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    recall_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    acc_losses <span class="op">=</span> []</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>    epoch_times <span class="op">=</span> []</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ckpt_dir=f"{os.environ['PBS_O_WORKDIR']}/checkpoints/{os.environ['PBS_JOBID']}"</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    ckpt_dir<span class="op">=</span>os.getcwd()</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(nepochs):</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>        tstamp<span class="op">=</span>time.strftime(<span class="st">"%H:%M:%S"</span>,time.localtime())</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'--------------------------------------------------------------------------------'</span>)</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>tstamp<span class="sc">}</span><span class="ss">: epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss"> start"</span>)</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>        epoch_start <span class="op">=</span> time.time()</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> epoch <span class="op">&lt;</span> <span class="dv">149</span>:</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> scheduler <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>                scheduler.step()</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'using scheduler: current learning rate = </span><span class="sc">{</span>scheduler<span class="sc">.</span>get_last_lr()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> param_group <span class="kw">in</span> optimizer.param_groups:</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>                param_group[<span class="st">'lr'</span>] <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"current learning rate = </span><span class="sc">{</span>optimizer<span class="sc">.</span>param_groups[<span class="dv">0</span>][<span class="st">'lr'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>        acc_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>        model.train()</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">#batch_num = 0</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inp, tar <span class="kw">in</span> tdl:</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>            <span class="co">#batch_num += 1</span></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>            <span class="co">#loss = 0</span></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>            inp <span class="op">=</span> inp.to(device)</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>            tar <span class="op">=</span> tar.to(device)</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>            prd <span class="op">=</span> model(inp)</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>            loss_delta <span class="op">=</span> l2loss_sphere(prd[:,:<span class="dv">5</span>,:,:], tar[:,:<span class="dv">5</span>,:,:], relative<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>            loss_tp <span class="op">=</span> torch.mean((prd[:,<span class="dv">5</span>:,:,:]<span class="op">-</span>tar[:,<span class="dv">5</span>:,:,:])<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> loss_delta <span class="op">+</span> loss_tp <span class="op">/</span> tar.shape[<span class="dv">1</span>]</span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> epoch <span class="op">&gt;</span> <span class="dv">150</span>:</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>                <span class="co">#print(f"add spectral loss")</span></span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>                lat_index <span class="op">=</span> np.r_[<span class="dv">7</span>:<span class="dv">15</span>, <span class="dv">32</span>:<span class="dv">40</span>]</span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>                out_fft <span class="op">=</span> torch.mean(torch.<span class="bu">abs</span>(torch.fft.rfft(prd[:,:,lat_index,:],dim<span class="op">=</span><span class="dv">3</span>)),dim<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>                target_fft <span class="op">=</span> torch.mean(torch.<span class="bu">abs</span>(torch.fft.rfft(tar[:,:,lat_index,:],dim<span class="op">=</span><span class="dv">3</span>)),dim<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>                loss_reg <span class="op">=</span> <span class="fl">0.05</span> <span class="op">*</span> torch.mean(torch.<span class="bu">abs</span>(out_fft <span class="op">-</span> target_fft))</span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> loss <span class="op">+</span> loss_reg</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>            acc_loss <span class="op">+=</span> loss.item()<span class="op">*</span> inp.size(<span class="dv">0</span>)</span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>        acc_losses.append(acc_loss <span class="op">/</span> <span class="bu">len</span>(tdl.dataset))</span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a>        epoch_times.append(time.time() <span class="op">-</span> epoch_start)</span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a>        tstamp<span class="op">=</span>time.strftime(<span class="st">"%H:%M:%S"</span>,time.localtime())</span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>tstamp<span class="sc">}</span><span class="ss">: Epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss"> summary:'</span>)</span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'time taken: </span><span class="sc">{</span>epoch_times[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'nsamples / sec: </span><span class="sc">{</span><span class="bu">len</span>(tdl.dataset)<span class="op">/</span>epoch_times[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'average training loss: </span><span class="sc">{</span>acc_losses[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> epoch <span class="op">&gt;=</span> <span class="dv">60</span>:</span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a>            rollout_steps <span class="op">=</span> <span class="dv">2920</span></span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a>            rollout <span class="op">=</span> torch.tensor(inference(model, rollout_steps, data_inp[<span class="dv">0</span>:<span class="dv">1</span>].to(device), data_inp[:<span class="dv">1460</span>,<span class="op">-</span><span class="dv">2</span>:].to(device), <span class="dv">1</span>, prog_means, prog_stds, diag_means, diag_stds, diff_stds)).to(device)</span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true" tabindex="-1"></a>            rollout_clim <span class="op">=</span> torch.mean(rollout[<span class="dv">1460</span>:],dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb27-86"><a href="#cb27-86" aria-hidden="true" tabindex="-1"></a>            clim_bias <span class="op">=</span> torch.mean(torch.<span class="bu">abs</span>(rollout_clim <span class="op">-</span> true_clim))</span>
<span id="cb27-87"><a href="#cb27-87" aria-hidden="true" tabindex="-1"></a>            ibs[<span class="dv">0</span>,epoch] <span class="op">=</span> clim_bias</span>
<span id="cb27-88"><a href="#cb27-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(ibs<span class="op">&gt;</span><span class="dv">0</span>)<span class="op">&lt;=</span><span class="dv">20</span>:</span>
<span id="cb27-89"><a href="#cb27-89" aria-hidden="true" tabindex="-1"></a>                infer_bias <span class="op">=</span> torch.mean(torch.tensor(ibs[<span class="dv">0</span>,<span class="dv">60</span>:epoch<span class="op">+</span><span class="dv">1</span>]))</span>
<span id="cb27-90"><a href="#cb27-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb27-91"><a href="#cb27-91" aria-hidden="true" tabindex="-1"></a>                infer_bias <span class="op">=</span> torch.mean(ibs[<span class="dv">0</span>,epoch<span class="op">-</span><span class="dv">20</span>:epoch<span class="op">+</span><span class="dv">1</span>])</span>
<span id="cb27-92"><a href="#cb27-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-93"><a href="#cb27-93" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'clim_bias: </span><span class="sc">{</span>clim_bias<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb27-94"><a href="#cb27-94" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'infer_bias: </span><span class="sc">{</span>infer_bias<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb27-95"><a href="#cb27-95" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> clim_bias <span class="op">&lt;=</span> best_bias:</span>
<span id="cb27-96"><a href="#cb27-96" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"new best clim_bias, save checkpoint"</span>)</span>
<span id="cb27-97"><a href="#cb27-97" aria-hidden="true" tabindex="-1"></a>                best_bias <span class="op">=</span> clim_bias</span>
<span id="cb27-98"><a href="#cb27-98" aria-hidden="true" tabindex="-1"></a>                <span class="co">#torch.save({"epoch":epoch,"model_state_dict":model.state_dict(),"optim_state_dict":optimizer.state_dict(),"sch_state_dict":scheduler.state_dict()},f"{ckpt_dir}/lucie_{epoch}.pt")</span></span>
<span id="cb27-99"><a href="#cb27-99" aria-hidden="true" tabindex="-1"></a>                torch.save(model.state_dict(), <span class="ss">f"</span><span class="sc">{</span>ckpt_dir<span class="sc">}</span><span class="ss">/regular_training_checkpoint.pth"</span>)</span>
<span id="cb27-100"><a href="#cb27-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-101"><a href="#cb27-101" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> epoch <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb27-102"><a href="#cb27-102" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">~</span>torch.isnan(clim_bias):</span>
<span id="cb27-103"><a href="#cb27-103" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> clim_bias <span class="op">&lt;=</span> infer_bias:</span>
<span id="cb27-104"><a href="#cb27-104" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#print(f"clim_bias &lt;= {infer_bias}, save checkpoint")</span></span>
<span id="cb27-105"><a href="#cb27-105" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#infer_bias = clim_bias</span></span>
<span id="cb27-106"><a href="#cb27-106" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#torch.save(model.state_dict(), f"{ckpt_dir}/regular_training_checkpoint.pth")</span></span>
<span id="cb27-107"><a href="#cb27-107" aria-hidden="true" tabindex="-1"></a>                        recall_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb27-108"><a href="#cb27-108" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb27-109"><a href="#cb27-109" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"clim_bias &gt; </span><span class="sc">{</span>infer_bias<span class="sc">}</span><span class="ss">, recall from latest checkpoint"</span>)</span>
<span id="cb27-110"><a href="#cb27-110" aria-hidden="true" tabindex="-1"></a>                        state_pth <span class="op">=</span> torch.load(<span class="ss">f"</span><span class="sc">{</span>ckpt_dir<span class="sc">}</span><span class="ss">/regular_training_checkpoint.pth"</span>)</span>
<span id="cb27-111"><a href="#cb27-111" aria-hidden="true" tabindex="-1"></a>                        model.load_state_dict(state_pth)</span>
<span id="cb27-112"><a href="#cb27-112" aria-hidden="true" tabindex="-1"></a>                        recall_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb27-113"><a href="#cb27-113" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> recall_count <span class="op">&gt;</span> <span class="dv">3</span>:</span>
<span id="cb27-114"><a href="#cb27-114" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c8f26337" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> load_data(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/datasets/era5_T30_regridded.npz"</span>)[...,:<span class="dv">6</span>]</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>true_clim <span class="op">=</span> torch.tensor(np.mean(data, axis<span class="op">=</span><span class="dv">0</span>)).to(device).permute(<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.load(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/datasets/era5_T30_preprocessed.npz"</span>)     <span class="co"># standardized data with mean and stds generated from dataset_generator.py</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>data_inp <span class="op">=</span> torch.tensor(data[<span class="st">"data_inp"</span>],dtype<span class="op">=</span>torch.float32)     <span class="co"># input data </span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>data_tar <span class="op">=</span> torch.tensor(data[<span class="st">"data_tar"</span>],dtype<span class="op">=</span>torch.float32)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>raw_means <span class="op">=</span> torch.tensor(data[<span class="st">"raw_means"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>raw_stds <span class="op">=</span> torch.tensor(data[<span class="st">"raw_stds"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>prog_means <span class="op">=</span> raw_means[:,:<span class="dv">5</span>]</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>prog_stds <span class="op">=</span> raw_stds[:,:<span class="dv">5</span>]</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>diag_means <span class="op">=</span> torch.tensor(data[<span class="st">"diag_means"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>diag_stds <span class="op">=</span> torch.tensor(data[<span class="st">"diag_stds"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>diff_means <span class="op">=</span> torch.tensor(data[<span class="st">"diff_means"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>diff_stds <span class="op">=</span> torch.tensor(data[<span class="st">"diff_stds"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>ntrain <span class="op">=</span> <span class="dv">16000</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>train_set <span class="op">=</span> TensorDataset(data_inp[:ntrain],data_tar[:ntrain])</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>train_loader <span class="op">=</span> DataLoader(train_set, batch_size<span class="op">=</span><span class="dv">16</span>, shuffle<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2ceecc6a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set the model</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>nlat <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>nlon <span class="op">=</span> <span class="dv">96</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>hard_thresholding_fraction <span class="op">=</span> <span class="fl">0.9</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>cost, quad_weights <span class="op">=</span> legendre_gauss_weights(nlat, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>quad_weights <span class="op">=</span> (torch.as_tensor(quad_weights).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)).to(device)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> SphericalFourierNeuralOperatorNet(params <span class="op">=</span> {}, spectral_transform<span class="op">=</span><span class="st">'sht'</span>, filter_type <span class="op">=</span> <span class="st">"linear"</span>, operator_type<span class="op">=</span><span class="st">'dhconv'</span>, img_shape<span class="op">=</span>(<span class="dv">48</span>, <span class="dv">96</span>),</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>                    num_layers<span class="op">=</span><span class="dv">8</span>, in_chans<span class="op">=</span><span class="dv">7</span>, out_chans<span class="op">=</span><span class="dv">6</span>, scale_factor<span class="op">=</span><span class="dv">1</span>, embed_dim<span class="op">=</span><span class="dv">72</span>, activation_function<span class="op">=</span><span class="st">"silu"</span>, big_skip<span class="op">=</span><span class="va">True</span>, pos_embed<span class="op">=</span><span class="st">"latlon"</span>, use_mlp<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>                                            normalization_layer<span class="op">=</span><span class="st">"instance_norm"</span>, hard_thresholding_fraction<span class="op">=</span>hard_thresholding_fraction,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>                                            mlp_ratio <span class="op">=</span> <span class="fl">2.</span>).to(device)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-4</span>, weight_decay<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>scheduler <span class="op">=</span> CosineAnnealingLR(optimizer, T_max<span class="op">=</span><span class="dv">150</span>, eta_min<span class="op">=</span><span class="fl">1e-5</span>)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters()))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>4122864</code></pre>
</div>
</div>
<div id="86f817df" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># it takes roughly 75 sec per epoch to train the original LUCIE model on a single V100</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># checkpoint saved at epoch 340 is available in `/g/data/dk92/notebooks/examples-aiml/lucie/checkpoints/`</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>nepochs<span class="op">=</span><span class="dv">3</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>train_model(model, train_loader, optimizer, scheduler<span class="op">=</span>scheduler, nepochs<span class="op">=</span>nepochs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>--------------------------------------------------------------------------------
18:39:35: epoch 0 start
using scheduler: current learning rate = [9.998026259498021e-05]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/envs/mlenv/lib/python3.10/site-packages/torch/optim/lr_scheduler.py:182: UserWarning: Detected call of `lr_scheduler.step()` before `optimizer.step()`. In PyTorch 1.1.0 and later, you should call them in the opposite order: `optimizer.step()` before `lr_scheduler.step()`.  Failure to do this will result in PyTorch skipping the first value of the learning rate schedule. See more details at https://pytorch.org/docs/stable/optim.html#how-to-adjust-learning-rate
  warnings.warn(
/opt/conda/envs/mlenv/lib/python3.10/site-packages/torch/optim/lr_scheduler.py:990: UserWarning: To get the last learning rate computed by the scheduler, please use `get_last_lr()`.
  _warn_get_lr_called_within_step(self)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>18:40:49: Epoch 0 summary:
time taken: 73.2493634223938
nsamples / sec: 218.43193240787235
average training loss: 0.568795047662941
--------------------------------------------------------------------------------
18:40:49: epoch 1 start
using scheduler: current learning rate = [9.993093369094605e-05]
18:42:02: Epoch 1 summary:
time taken: 73.02629399299622
nsamples / sec: 219.0991644945658
average training loss: 0.44222918830883634
--------------------------------------------------------------------------------
18:42:02: epoch 2 start
using scheduler: current learning rate = [9.986190524833163e-05]
18:43:15: Epoch 2 summary:
time taken: 72.95869874954224
nsamples / sec: 219.30215689462784
average training loss: 0.4068589104065609</code></pre>
</div>
</div>
<section id="suggested-exercises" class="level2">
<h2 class="anchored" data-anchor-id="suggested-exercises">Suggested Exercises</h2>
<ol type="1">
<li>plot the learning curve of the training: y-axis: average training loss, x-axis: epoch.</li>
<li>modify <code>rollout_clim</code> and <code>true_clim</code> to be the latitude-weighted global mean and re-run the training</li>
<li>try expand the region where the added spectral loss covers and re-run the training.</li>
</ol>
</section>
</section>
<section id="modified-training" class="level1">
<h1>Modified Training</h1>
<div id="3b318824" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>module <span class="bu">list</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Currently Loaded Modulefiles:
 1) openmpi/4.1.5   2) singularity   3) NCI-ai-ml/25.07   4) pbs  </code></pre>
</div>
</div>
<div id="69fefe32" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> TensorDataset, DataLoader</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.optim.lr_scheduler <span class="im">import</span> CosineAnnealingLR</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys,os,time</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>nb_dir<span class="op">=</span><span class="st">"/g/data/dk92/notebooks/examples-aiml/lucie"</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/models"</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch_harmonics_local_v2 <span class="im">import</span> <span class="op">*</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda:0'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    torch.cuda.set_device(<span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b80af6da" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># normalization function used for static channels. </span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _minmax(img):</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.as_tensor((img<span class="op">-</span>img.<span class="bu">min</span>())<span class="op">/</span>(img.<span class="bu">max</span>()<span class="op">-</span>img.<span class="bu">min</span>()))</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_t30_grid():</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    nlat <span class="op">=</span> <span class="dv">48</span>  <span class="co"># Number of latitudes</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    nlon <span class="op">=</span> <span class="dv">96</span>  <span class="co"># Number of longitudes</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Gaussian latitudes and weights</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    latitudes, weights <span class="op">=</span> np.polynomial.legendre.leggauss(nlat)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    latitudes <span class="op">=</span> np.arcsin(latitudes) <span class="op">*</span> (<span class="fl">180.0</span> <span class="op">/</span> np.pi)  <span class="co"># Convert to degrees</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Longitudes</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    longitudes <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">360</span>, nlon, endpoint<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> latitudes, longitudes</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c9ceb23b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># modified inference function adapted to lat,lon inputs</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inference(model, steps, initial_frame, forcing, initial_forcing_idx, prog_means, prog_stds, diag_means, diag_stds, diff_stds):</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    inf_data <span class="op">=</span> []</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    inp_const <span class="op">=</span>const_chans.to(device,dtype<span class="op">=</span>torch.float32)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        inp_val <span class="op">=</span> initial_frame</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(steps):</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>            forcing_idx <span class="op">=</span> (initial_forcing_idx <span class="op">+</span> i) <span class="op">%</span> <span class="dv">1460</span>      <span class="co"># tisr is repeating and orography is </span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>            previous <span class="op">=</span> inp_val[:,:<span class="dv">5</span>,:,:]</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>            inpc_val <span class="op">=</span> torch.cat([inp_const, inp_val],dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>            pred <span class="op">=</span> model(inpc_val)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>            pred[:,:<span class="dv">5</span>,:,:] <span class="op">=</span> pred[:,:<span class="dv">5</span>,:,:] <span class="op">*</span> diff_stds         <span class="co"># denormalize the predicted tendency</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>            <span class="co"># demornalzie the previous time step and add to the tendecy to reconstruct the current field</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>            pred[:,:<span class="dv">5</span>,:,:] <span class="op">+=</span> previous[:,:<span class="dv">5</span>,:,:] <span class="op">*</span> prog_stds <span class="op">+</span> prog_means</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>            tp_frame <span class="op">=</span> pred[:,<span class="dv">5</span>:,:,:] <span class="op">*</span> diag_stds <span class="op">+</span> diag_means</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>            raw <span class="op">=</span> torch.cat((pred[:,:<span class="dv">5</span>,:,:],tp_frame), <span class="dv">1</span>)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>            inp_val <span class="op">=</span> (raw[:,:<span class="dv">5</span>,:,:] <span class="op">-</span> prog_means) <span class="op">/</span> prog_stds      <span class="co"># normalize the current time step for autoregressive prediction</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>            inp_val <span class="op">=</span> torch.cat((inp_val, forcing[forcing_idx,:,:,:].reshape(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">48</span>,<span class="dv">96</span>)), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>            raw <span class="op">=</span> raw.cpu().clone().detach().numpy()</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>            inf_data.append(raw[<span class="dv">0</span>])</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    inf_data <span class="op">=</span> np.array(inf_data)</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>    inf_data[:,<span class="dv">5</span>,:,:] <span class="op">=</span> (np.exp(inf_data[:,<span class="dv">5</span>,:,:]) <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> <span class="fl">1e-2</span>      <span class="co"># denormalzie precipitation that was normalized in log space</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> inf_data</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="2ae6c98a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define util functions, overide the one defined in LUCIE_train.py</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> integrate_grid(ugrid):</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    dlon <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> torch.pi <span class="op">/</span> nlon</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> torch.<span class="bu">sum</span>(ugrid <span class="op">*</span> quad_weights <span class="op">*</span> dlon, dim<span class="op">=</span>(<span class="op">-</span><span class="dv">2</span>, <span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> out</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> l2loss_sphere(prd, tar, relative<span class="op">=</span><span class="va">False</span>, squared<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> integrate_grid((prd <span class="op">-</span> tar)<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>(dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> relative:</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> loss <span class="op">/</span> integrate_grid(tar<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>(dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> squared:</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> torch.sqrt(loss)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> loss.mean()</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> loss</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(model, tdl, optimizer, scheduler<span class="op">=</span><span class="va">None</span>, nepochs<span class="op">=</span><span class="dv">20</span>, loss_fn<span class="op">=</span><span class="st">'l2'</span>):</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    infer_bias <span class="op">=</span> <span class="fl">1e+80</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    ibs <span class="op">=</span> torch.zeros(<span class="dv">1</span>,nepochs)</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    best_bias <span class="op">=</span> <span class="fl">1e+80</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    recall_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    acc_losses <span class="op">=</span> []</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    epoch_times <span class="op">=</span> []</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#ckpt_dir=f"{os.environ['PBS_O_WORKDIR']}/checkpoints/{os.environ['PBS_JOBID']}"</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(nepochs):</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>        tstamp<span class="op">=</span>time.strftime(<span class="st">"%H:%M:%S"</span>,time.localtime())</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'--------------------------------------------------------------------------------'</span>)</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>tstamp<span class="sc">}</span><span class="ss">: epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss"> start"</span>)</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>        epoch_start <span class="op">=</span> time.time()</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> epoch <span class="op">&lt;</span> <span class="dv">149</span>:</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> scheduler <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>                scheduler.step()</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'using scheduler: current learning rate = </span><span class="sc">{</span>scheduler<span class="sc">.</span>get_last_lr()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> param_group <span class="kw">in</span> optimizer.param_groups:</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>                param_group[<span class="st">'lr'</span>] <span class="op">=</span> <span class="fl">1e-6</span></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"current learning rate = </span><span class="sc">{</span>optimizer<span class="sc">.</span>param_groups[<span class="dv">0</span>][<span class="st">'lr'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>        acc_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a>        model.train()</span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">#batch_num = 0</span></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> inp, tar <span class="kw">in</span> tdl:</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>            <span class="co">#batch_num += 1</span></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>            <span class="co">#loss = 0</span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>            <span class="co">#inp = inp.to(device)</span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># adding lat, lon as the first two channels</span></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>            inpc <span class="op">=</span> torch.cat([const_chans_t, inp],dim<span class="op">=</span><span class="dv">1</span>).to(device,dtype<span class="op">=</span>torch.float32)</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>            tar <span class="op">=</span> tar.to(device)</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>            prd <span class="op">=</span> model(inpc)</span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># prd and tar shape are not affected, keep this section</span></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>            loss_delta <span class="op">=</span> l2loss_sphere(prd[:,:<span class="dv">5</span>,:,:], tar[:,:<span class="dv">5</span>,:,:], relative<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a>            loss_tp <span class="op">=</span> torch.mean((prd[:,<span class="dv">5</span>:,:,:]<span class="op">-</span>tar[:,<span class="dv">5</span>:,:,:])<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> loss_delta <span class="op">+</span> loss_tp <span class="op">/</span> tar.shape[<span class="dv">1</span>]</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> epoch <span class="op">&gt;</span> <span class="dv">150</span>:</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a>                <span class="co">#print(f"add spectral loss")</span></span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a>                lat_index <span class="op">=</span> np.r_[<span class="dv">7</span>:<span class="dv">15</span>, <span class="dv">32</span>:<span class="dv">40</span>]</span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a>                out_fft <span class="op">=</span> torch.mean(torch.<span class="bu">abs</span>(torch.fft.rfft(prd[:,:,lat_index,:],dim<span class="op">=</span><span class="dv">3</span>)),dim<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>                target_fft <span class="op">=</span> torch.mean(torch.<span class="bu">abs</span>(torch.fft.rfft(tar[:,:,lat_index,:],dim<span class="op">=</span><span class="dv">3</span>)),dim<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a>                loss_reg <span class="op">=</span> <span class="fl">0.05</span> <span class="op">*</span> torch.mean(torch.<span class="bu">abs</span>(out_fft <span class="op">-</span> target_fft))</span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> loss <span class="op">+</span> loss_reg</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb40-72"><a href="#cb40-72" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb40-73"><a href="#cb40-73" aria-hidden="true" tabindex="-1"></a>            acc_loss <span class="op">+=</span> loss.item()<span class="op">*</span> inp.size(<span class="dv">0</span>)</span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a>        acc_losses.append(acc_loss <span class="op">/</span> <span class="bu">len</span>(tdl.dataset))</span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a>        epoch_times.append(time.time() <span class="op">-</span> epoch_start)</span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>        tstamp<span class="op">=</span>time.strftime(<span class="st">"%H:%M:%S"</span>,time.localtime())</span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>tstamp<span class="sc">}</span><span class="ss">: Epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss"> summary:'</span>)</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'time taken: </span><span class="sc">{</span>epoch_times[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'nsamples / sec: </span><span class="sc">{</span><span class="bu">len</span>(tdl.dataset)<span class="op">/</span>epoch_times[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'average training loss: </span><span class="sc">{</span>acc_losses[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> epoch <span class="op">&gt;=</span> <span class="dv">60</span>:</span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a>            rollout_steps <span class="op">=</span> <span class="dv">2920</span></span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a>            rollout <span class="op">=</span> torch.tensor(inference(model, rollout_steps, data_inp[<span class="dv">0</span>:<span class="dv">1</span>].to(device), data_inp[:<span class="dv">1460</span>,<span class="op">-</span><span class="dv">2</span>:].to(device), <span class="dv">1</span>, prog_means, prog_stds, diag_means, diag_stds, diff_stds)).to(device)</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a>            rollout_clim <span class="op">=</span> torch.mean(rollout[<span class="dv">1460</span>:],dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a>            clim_bias <span class="op">=</span> torch.mean(torch.<span class="bu">abs</span>(rollout_clim <span class="op">-</span> true_clim))</span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a>            ibs[<span class="dv">0</span>,epoch] <span class="op">=</span> clim_bias</span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(ibs<span class="op">&gt;</span><span class="dv">0</span>)<span class="op">&lt;=</span><span class="dv">20</span>:</span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a>                infer_bias <span class="op">=</span> torch.mean(torch.tensor(ibs[<span class="dv">0</span>,<span class="dv">60</span>:epoch<span class="op">+</span><span class="dv">1</span>]))</span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a>                infer_bias <span class="op">=</span> torch.mean(ibs[<span class="dv">0</span>,epoch<span class="op">-</span><span class="dv">20</span>:epoch<span class="op">+</span><span class="dv">1</span>])</span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'clim_bias: </span><span class="sc">{</span>clim_bias<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'infer_bias: </span><span class="sc">{</span>infer_bias<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> clim_bias <span class="op">&lt;=</span> best_bias:</span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"new best clim_bias, save checkpoint"</span>)</span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a>                best_bias <span class="op">=</span> clim_bias</span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a>                <span class="co">#torch.save({"epoch":epoch,"model_state_dict":model.state_dict(),"optim_state_dict":optimizer.state_dict(),"sch_state_dict":scheduler.state_dict()},f"{ckpt_dir}/lucie_{epoch}.pt")</span></span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>                torch.save(model.state_dict(), <span class="ss">f"</span><span class="sc">{</span>ckpt_dir<span class="sc">}</span><span class="ss">/regular_training_checkpoint.pth"</span>)</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> epoch <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">~</span>torch.isnan(clim_bias): </span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> clim_bias <span class="op">&lt;=</span> infer_bias:</span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#print(f"clim_bias &lt;= {infer_bias}, save checkpoint")</span></span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#infer_bias = clim_bias</span></span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a>                        <span class="co">#torch.save(model.state_dict(), f"{ckpt_dir}/regular_training_checkpoint.pth")</span></span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a>                        recall_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f"clim_bias &gt; </span><span class="sc">{</span>infer_bias<span class="sc">}</span><span class="ss">, recall from latest checkpoint"</span>)</span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a>                        state_pth <span class="op">=</span> torch.load(<span class="ss">f"</span><span class="sc">{</span>ckpt_dir<span class="sc">}</span><span class="ss">/regular_training_checkpoint.pth"</span>)</span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a>                        model.load_state_dict(state_pth)</span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a>                        recall_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> recall_count <span class="op">&gt;</span> <span class="dv">3</span>:</span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="242f9ea1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load data</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> load_data(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/datasets/era5_T30_regridded.npz"</span>)[...,:<span class="dv">6</span>]</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>true_clim <span class="op">=</span> torch.tensor(np.mean(data, axis<span class="op">=</span><span class="dv">0</span>)).to(device).permute(<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.load(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/datasets/era5_T30_preprocessed.npz"</span>)     <span class="co"># standardized data with mean and stds generated from dataset_generator.py</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>data_inp <span class="op">=</span> torch.tensor(data[<span class="st">"data_inp"</span>],dtype<span class="op">=</span>torch.float32)     <span class="co"># input data </span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>data_tar <span class="op">=</span> torch.tensor(data[<span class="st">"data_tar"</span>],dtype<span class="op">=</span>torch.float32)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>raw_means <span class="op">=</span> torch.tensor(data[<span class="st">"raw_means"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>raw_stds <span class="op">=</span> torch.tensor(data[<span class="st">"raw_stds"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>prog_means <span class="op">=</span> raw_means[:,:<span class="dv">5</span>]</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>prog_stds <span class="op">=</span> raw_stds[:,:<span class="dv">5</span>]</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>diag_means <span class="op">=</span> torch.tensor(data[<span class="st">"diag_means"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>diag_stds <span class="op">=</span> torch.tensor(data[<span class="st">"diag_stds"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>diff_means <span class="op">=</span> torch.tensor(data[<span class="st">"diff_means"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>diff_stds <span class="op">=</span> torch.tensor(data[<span class="st">"diff_stds"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>ntrain <span class="op">=</span> <span class="dv">16000</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>train_set <span class="op">=</span> TensorDataset(data_inp[:ntrain],data_tar[:ntrain])</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>train_loader <span class="op">=</span> DataLoader(train_set, batch_size<span class="op">=</span><span class="dv">16</span>, shuffle<span class="op">=</span><span class="va">True</span>, drop_last<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="co"># generate the const channels</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>lats, lons <span class="op">=</span> generate_t30_grid()</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>lon2d, lat2d <span class="op">=</span> np.meshgrid(lons, lats)</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>const_chans <span class="op">=</span> _minmax(np.stack([_minmax(lat2d), _minmax(lon2d)])).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>const_chans_t <span class="op">=</span> const_chans.expand(<span class="dv">16</span>, <span class="dv">2</span>, <span class="dv">48</span>, <span class="dv">96</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="15b73d5c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set the model</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>nlat <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>nlon <span class="op">=</span> <span class="dv">96</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>hard_thresholding_fraction <span class="op">=</span> <span class="fl">0.9</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>cost, quad_weights <span class="op">=</span> legendre_gauss_weights(nlat, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>quad_weights <span class="op">=</span> (torch.as_tensor(quad_weights).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)).to(device)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> SphericalFourierNeuralOperatorNet(params <span class="op">=</span> {}, spectral_transform<span class="op">=</span><span class="st">'sht'</span>, filter_type <span class="op">=</span> <span class="st">"linear"</span>, operator_type<span class="op">=</span><span class="st">'dhconv'</span>, img_shape<span class="op">=</span>(<span class="dv">48</span>, <span class="dv">96</span>),num_layers<span class="op">=</span><span class="dv">8</span>, in_chans<span class="op">=</span><span class="dv">9</span>, out_chans<span class="op">=</span><span class="dv">6</span>, scale_factor<span class="op">=</span><span class="dv">1</span>, embed_dim<span class="op">=</span><span class="dv">72</span>, activation_function<span class="op">=</span><span class="st">"silu"</span>, big_skip<span class="op">=</span><span class="va">True</span>, pos_embed<span class="op">=</span><span class="va">False</span>, use_mlp<span class="op">=</span><span class="va">True</span>,normalization_layer<span class="op">=</span><span class="st">"instance_norm"</span>, hard_thresholding_fraction<span class="op">=</span>hard_thresholding_fraction,mlp_ratio <span class="op">=</span> <span class="fl">2.</span>).to(device)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-4</span>, weight_decay<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>scheduler <span class="op">=</span> CosineAnnealingLR(optimizer, T_max<span class="op">=</span><span class="dv">150</span>, eta_min<span class="op">=</span><span class="fl">1e-5</span>)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters()))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>3791376</code></pre>
</div>
</div>
<div id="dccbbaab" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># it takes roughly 75 sec per epoch to train the modified LUCIE model on a single V100</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="co"># checkpoints saved at epoch 193 and 219 are available in `/g/data/dk92/notebooks/examples-aiml/lucie/checkpoints/`</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>nepochs<span class="op">=</span><span class="dv">3</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>train_model(model, train_loader, optimizer, scheduler<span class="op">=</span>scheduler, nepochs<span class="op">=</span>nepochs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>--------------------------------------------------------------------------------
17:55:28: epoch 0 start
using scheduler: current learning rate = [9.999013075636805e-05]</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/envs/mlenv/lib/python3.10/site-packages/torch/optim/lr_scheduler.py:182: UserWarning: Detected call of `lr_scheduler.step()` before `optimizer.step()`. In PyTorch 1.1.0 and later, you should call them in the opposite order: `optimizer.step()` before `lr_scheduler.step()`.  Failure to do this will result in PyTorch skipping the first value of the learning rate schedule. See more details at https://pytorch.org/docs/stable/optim.html#how-to-adjust-learning-rate
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>17:56:44: Epoch 0 summary:
time taken: 75.56519341468811
nsamples / sec: 211.73769664288284
average training loss: 0.5649356337823864
--------------------------------------------------------------------------------
17:56:44: epoch 1 start
using scheduler: current learning rate = [9.996052735444863e-05]
17:57:58: Epoch 1 summary:
time taken: 74.5183458328247
nsamples / sec: 214.71222718623653
average training loss: 0.4445175377408696
--------------------------------------------------------------------------------
17:57:58: epoch 2 start
using scheduler: current learning rate = [9.991120277927221e-05]
17:59:13: Epoch 2 summary:
time taken: 74.4180178642273
nsamples / sec: 215.00169527749802
average training loss: 0.41059033054741506</code></pre>
</div>
</div>
<section id="suggested-exercises-1" class="level2">
<h2 class="anchored" data-anchor-id="suggested-exercises-1">Suggested Exercises</h2>
<ol type="1">
<li>identify the difference between the above <code>model</code> and the <code>model</code> used in <code>/g/data/dk92/notebooks/examples-aiml/lucie/replicate_training.ipynb</code>.</li>
<li>compare learning curve of this training and the one defined in <code>/g/data/dk92/notebooks/examples-aiml/lucie/replicate_training.ipynb</code>.</li>
<li>compare rollouts generated from this model and the one trained in <code>/g/data/dk92/notebooks/examples-aiml/lucie/replicate_training.ipynb</code>.</li>
<li>modify the model further to have higher embedding dimension in the feature space.</li>
</ol>
</section>
</section>
<section id="inference" class="level1">
<h1>Inference</h1>
<div id="ee261f5c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>module <span class="bu">list</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Currently Loaded Modulefiles:
 1) openmpi/4.1.5   2) singularity   3) NCI-ai-ml/25.07   4) pbs  </code></pre>
</div>
</div>
<div id="f344eaaf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> math <span class="im">import</span> ceil</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys,os,time</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>nb_dir<span class="op">=</span><span class="st">"/g/data/dk92/notebooks/examples-aiml/lucie"</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/models"</span>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch_harmonics_local <span class="im">import</span> <span class="op">*</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> LUCIE_inference <span class="im">import</span> inference</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda:0'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> torch.cuda.is_available():</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>    torch.cuda.set_device(<span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="903723a9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the ground truth for clim_bias from the original work</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> load_data(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/datasets/era5_T30_regridded.npz"</span>)[...,:<span class="dv">6</span>]</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>true_clim <span class="op">=</span> torch.tensor(np.mean(data, axis<span class="op">=</span><span class="dv">0</span>)).to(device).permute(<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e63eda6e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load the normalization scalars from the original work</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> np.load(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/datasets/era5_T30_preprocessed.npz"</span>)     <span class="co"># standardized data with mean and stds generated from dataset_generator.py</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>data_inp <span class="op">=</span> torch.tensor(data[<span class="st">"data_inp"</span>],dtype<span class="op">=</span>torch.float32)     <span class="co"># input data </span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>data_tar <span class="op">=</span> torch.tensor(data[<span class="st">"data_tar"</span>],dtype<span class="op">=</span>torch.float32)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>raw_means <span class="op">=</span> torch.tensor(data[<span class="st">"raw_means"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>raw_stds <span class="op">=</span> torch.tensor(data[<span class="st">"raw_stds"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>prog_means <span class="op">=</span> raw_means[:,:<span class="dv">5</span>]</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>prog_stds <span class="op">=</span> raw_stds[:,:<span class="dv">5</span>]</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>diag_means <span class="op">=</span> torch.tensor(data[<span class="st">"diag_means"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>diag_stds <span class="op">=</span> torch.tensor(data[<span class="st">"diag_stds"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>diff_means <span class="op">=</span> torch.tensor(data[<span class="st">"diff_means"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>diff_stds <span class="op">=</span> torch.tensor(data[<span class="st">"diff_stds"</span>],dtype<span class="op">=</span>torch.float32).reshape(<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>).to(device)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="03746d0d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize the SFNO model</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>grid<span class="op">=</span><span class="st">'legendre-gauss'</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>nlat <span class="op">=</span> <span class="dv">48</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>nlon <span class="op">=</span> <span class="dv">96</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>hard_thresholding_fraction <span class="op">=</span> <span class="fl">0.9</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>lmax <span class="op">=</span> ceil(nlat <span class="op">/</span> <span class="dv">1</span>)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>mmax <span class="op">=</span> lmax</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>modes_lat <span class="op">=</span> <span class="bu">int</span>(nlat <span class="op">*</span> hard_thresholding_fraction)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>modes_lon <span class="op">=</span> <span class="bu">int</span>(nlon<span class="op">//</span><span class="dv">2</span> <span class="op">*</span> hard_thresholding_fraction)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>modes_lat <span class="op">=</span> modes_lon <span class="op">=</span> <span class="bu">min</span>(modes_lat, modes_lon)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>sht <span class="op">=</span> RealSHT(nlat, nlon, lmax<span class="op">=</span>modes_lat, mmax<span class="op">=</span>modes_lon, grid<span class="op">=</span>grid, csphase<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>radius<span class="op">=</span><span class="fl">6.37122E6</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>cost, quad_weights <span class="op">=</span> legendre_gauss_weights(nlat, <span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>quad_weights <span class="op">=</span> (torch.as_tensor(quad_weights).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)).to(device)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> SphericalFourierNeuralOperatorNet(params <span class="op">=</span> {}, spectral_transform<span class="op">=</span><span class="st">'sht'</span>, filter_type <span class="op">=</span> <span class="st">"linear"</span>, operator_type<span class="op">=</span><span class="st">'dhconv'</span>, img_shape<span class="op">=</span>(<span class="dv">48</span>, <span class="dv">96</span>),</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>                    num_layers<span class="op">=</span><span class="dv">8</span>, in_chans<span class="op">=</span><span class="dv">7</span>, out_chans<span class="op">=</span><span class="dv">6</span>, scale_factor<span class="op">=</span><span class="dv">1</span>, embed_dim<span class="op">=</span><span class="dv">72</span>, activation_function<span class="op">=</span><span class="st">"silu"</span>, big_skip<span class="op">=</span><span class="va">True</span>, pos_embed<span class="op">=</span><span class="st">"latlon"</span>, use_mlp<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>                                            normalization_layer<span class="op">=</span><span class="st">"instance_norm"</span>, hard_thresholding_fraction<span class="op">=</span>hard_thresholding_fraction,</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>                                            mlp_ratio <span class="op">=</span> <span class="fl">2.</span>).to(device)</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>gadi<span class="op">=</span><span class="va">False</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> gadi:</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">#load checkpoint trained on Gadi</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"loading LUCIE checkpoint trained on Gadi"</span>)</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>  pth <span class="op">=</span> torch.load(<span class="ss">f'</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/checkpoints/nci_rep_lucie_340.pt'</span>)</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>  model.load_state_dict(pth[<span class="st">"model_state_dict"</span>])</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"loading original LUCIE checkpoint"</span>)</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>  pth <span class="op">=</span> torch.load(<span class="ss">f'</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/checkpoints/regular_8x72_fftreg_baseline.pth'</span>)</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>  model.load_state_dict(pth)</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a><span class="co"># run rollout for 10 years</span></span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>forcing <span class="op">=</span> data_inp[:<span class="dv">1460</span>,<span class="op">-</span><span class="dv">2</span>:]   <span class="co"># repeating tisr and constant oro</span></span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>rollout_step <span class="op">=</span> <span class="dv">14600</span> <span class="co"># 10y of rollout</span></span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>initial_frame_idx <span class="op">=</span> <span class="dv">16000</span><span class="op">+</span><span class="dv">100</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>forcing_initial_idx <span class="op">=</span> (<span class="dv">16000</span><span class="op">+</span><span class="dv">100</span>) <span class="op">%</span> <span class="dv">1460</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>rollout <span class="op">=</span> inference(model, rollout_step, data_inp[initial_frame_idx].unsqueeze(<span class="dv">0</span>).to(device), forcing.to(device), forcing_initial_idx, prog_means, prog_stds, diag_means, diag_stds, diff_stds)</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rollout.shape)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>loading original LUCIE checkpoint</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/g/data/dk92/notebooks/examples-aiml/lucie/models/torch_harmonics_local.py:1242: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  with amp.autocast(enabled=False):
/g/data/dk92/notebooks/examples-aiml/lucie/models/torch_harmonics_local.py:1263: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  with amp.autocast(enabled=False):</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>(14600, 6, 48, 96)</code></pre>
</div>
</div>
<section id="visualize-rollout-results" class="level2">
<h2 class="anchored" data-anchor-id="visualize-rollout-results">Visualize Rollout Results</h2>
<div id="952a4555" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare for visualization</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_t30_grid():</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># T62 Gaussian grid parameters</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    nlat <span class="op">=</span> <span class="dv">48</span>  <span class="co"># Number of latitudes</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    nlon <span class="op">=</span> <span class="dv">96</span>  <span class="co"># Number of longitudes</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Gaussian latitudes and weights</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    latitudes, weights <span class="op">=</span> np.polynomial.legendre.leggauss(nlat)</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    latitudes <span class="op">=</span> np.arcsin(latitudes) <span class="op">*</span> (<span class="fl">180.0</span> <span class="op">/</span> np.pi)  <span class="co"># Convert to degrees</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Longitudes</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    longitudes <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">360</span>, nlon, endpoint<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> latitudes, longitudes</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>lat, lon <span class="op">=</span> generate_t30_grid()</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a><span class="bu">vars</span> <span class="op">=</span> [<span class="st">'temperature'</span>, <span class="st">'humidity'</span>, <span class="st">'u_wind'</span>, <span class="st">'v_wind'</span>, <span class="st">'surface_pressure'</span>, <span class="st">'precipitation'</span>]</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>nvars<span class="op">=</span><span class="bu">len</span>(<span class="bu">vars</span>)</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>Lon, Lat <span class="op">=</span> np.meshgrid(lon, lat)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="check-the-spatial-pattern" class="level2">
<h2 class="anchored" data-anchor-id="check-the-spatial-pattern">Check the Spatial Pattern</h2>
<div id="dd8985ca" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">#results from Yue's checkpoint</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co"># path = torch.load(f'{wdir}/checkpoints/136618981.gadi-pbs/regular_training_checkpoint.pth')</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co"># model.load_state_dict(path)</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co"># better checkpoint</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co">#path = torch.load(f'{wdir}/checkpoints/137286020.gadi-pbs/lucie_205.pt')</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="co">#path = torch.load(f'{wdir}/checkpoints/137478626.gadi-pbs/lucie_158.pt')</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="co">#path = torch.load(f'{wdir}/checkpoints/138987659.gadi-pbs/lucie_340.pt')</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="co">#model.load_state_dict(path["model_state_dict"])</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="co">#rollout = inference(model, rollout_step, data_inp[initial_frame_idx].unsqueeze(0).to(device), forcing.to(device), forcing_initial_idx, prog_means, prog_stds, diag_means, diag_stds, diff_stds)</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the final timestep of each ouptut var</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>w,h <span class="op">=</span> <span class="dv">12</span>,<span class="dv">5</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>fig,axs <span class="op">=</span> plt.subplots(nvars,<span class="dv">1</span>, figsize<span class="op">=</span>(w,h<span class="op">*</span>nvars),subplot_kw<span class="op">=</span>{<span class="st">'projection'</span>: ccrs.PlateCarree()},squeeze<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>Lon, Lat <span class="op">=</span> np.meshgrid(lon, lat)</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ii <span class="kw">in</span> <span class="bu">range</span>(nvars):</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    pcm <span class="op">=</span> axs[ii,<span class="dv">0</span>].pcolormesh(Lon,Lat,rollout[<span class="op">-</span><span class="dv">1</span>,ii,:,:])</span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>    axs[ii,<span class="dv">0</span>].coastlines()</span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>    axs[ii,<span class="dv">0</span>].set_title(<span class="ss">f"</span><span class="sc">{</span><span class="bu">vars</span>[ii]<span class="sc">}</span><span class="ss"> at step </span><span class="sc">{</span>rollout<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>    fig.colorbar(pcm, ax<span class="op">=</span>axs[ii])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="lucie_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="check-climatology-bias" class="level2">
<h2 class="anchored" data-anchor-id="check-climatology-bias">Check Climatology Bias</h2>
<div id="01580bd8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mean clim_bias between year 1 and 10, it is expected to be different from what reported in the training </span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>rollout_clim <span class="op">=</span> torch.mean(torch.tensor(rollout[<span class="dv">1460</span>:]).to(device),dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>clim_bias <span class="op">=</span> torch.mean(torch.<span class="bu">abs</span>(rollout_clim <span class="op">-</span> true_clim))</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>clim_bias</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(18.2533, device='cuda:0')</code></pre>
</div>
</div>
<div id="2ad96bea" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># relative clim_bias by vars</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>rel_clim_bias <span class="op">=</span> torch.mean(torch.<span class="bu">abs</span>((rollout_clim <span class="op">-</span> true_clim)<span class="op">/</span>true_clim),dim<span class="op">=</span>(<span class="op">-</span><span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(<span class="bu">zip</span>(<span class="bu">vars</span>,rel_clim_bias.tolist()))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[('temperature', 0.0021463886369019747),
 ('humidity', 0.09310100972652435),
 ('u_wind', 2.2337892055511475),
 ('v_wind', 2.5637850761413574),
 ('surface_pressure', 0.001107409130781889),
 ('precipitation', 0.14571672677993774)]</code></pre>
</div>
</div>
</section>
<section id="compare-global-mean-over-time" class="level2">
<h2 class="anchored" data-anchor-id="compare-global-mean-over-time">Compare Global Mean over Time</h2>
<div id="0b3a7b5b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare global mean over time [year 1, year 10]</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> load_data(<span class="ss">f"</span><span class="sc">{</span>nb_dir<span class="sc">}</span><span class="ss">/datasets/era5_T30_regridded.npz"</span>)[...,:<span class="dv">6</span>]</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>true_clim_t <span class="op">=</span> np.mean(data[<span class="dv">1460</span>:<span class="dv">14600</span>], axis<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> torch.tensor(rollout[<span class="dv">1460</span>:]).detach()</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>pred_clim_t <span class="op">=</span> torch.mean(pred,dim<span class="op">=</span>(<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4e7d42a3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>fig,axs <span class="op">=</span> plt.subplots(nvars,<span class="dv">1</span>, figsize<span class="op">=</span>(w<span class="op">*</span><span class="dv">3</span>,h<span class="op">*</span>nvars))</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ii <span class="kw">in</span> <span class="bu">range</span>(nvars):</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    pcm1 <span class="op">=</span> axs[ii].plot(true_clim_t[:,ii],label<span class="op">=</span><span class="ss">f"targ_</span><span class="sc">{</span><span class="bu">vars</span>[ii]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    pcm2 <span class="op">=</span> axs[ii].plot(pred_clim_t[:,ii],label<span class="op">=</span><span class="ss">f"pred_</span><span class="sc">{</span><span class="bu">vars</span>[ii]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    axs[ii].set_title(<span class="ss">f"</span><span class="sc">{</span><span class="bu">vars</span>[ii]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    axs[ii].legend(loc<span class="op">=</span><span class="st">'upper left'</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">1.003</span>, <span class="dv">1</span>),fontsize<span class="op">=</span><span class="dv">16</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="lucie_files/figure-html/cell-40-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="suggested-exercises-2" class="level2">
<h2 class="anchored" data-anchor-id="suggested-exercises-2">Suggested Exercises</h2>
<ol type="1">
<li>Compare rollout results from both checkpoints.<br>
</li>
<li>Use a different metric to quantify the difference between prediction and the ground truth over time.<br>
</li>
<li>Track the spatial pattern evolution of an individual variable field over time.<br>
</li>
<li>Run the notebook <code>/g/data/dk92/notebooks/examples-aiml/lucie/modified_training.ipynb</code> and generate the 10-year inference for its model with the checkpoints <code>nci_mod_lucie_193.pt</code> and/or <code>nci_mod_lucie_219.pt</code> inside the directory <code>/g/data/dk92/notebooks/examples-aiml/lucie/checkpoints/</code>.</li>
</ol>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/NCI900-Training-Organisation\.github\.io\/learning-resources\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.dev/NCI900-Training-Organisation/learning-resources.git/blob/main/Example-Notebooks/lucie.ipynb" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/NCI900-Training-Organisation/learning-resources.git/blob/main/Example-Notebooks/lucie.ipynb" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/NCI900-Training-Organisation/learning-resources.git/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>